<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css" rel="stylesheet">
    <link rel="stylesheet" href="sound-styles.css">
    <title>Supersonicas</title>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154332648-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-154332648-1');
    </script>
</head>

<body>

<div>
    <div id="details-view">
        <h1>Supersonicas</h1>
        <button id="chromesthesia-button" class="pattern-button" aria-label="Chromesthesia">Chromesthesia</button>
        <button id="emotion-button" class="pattern-button" aria-label="Emotion">Emotion</button>
        <button id="chakras-button" class="pattern-button" aria-label="Chakras">Chakras</button>
        </br>
        <button id="adolescence-button" class="pattern-button" aria-label="Adolescence">Adolescence</button>
        <button id="monochromacy-button" class="pattern-button" aria-label="Monochromacy">Monochromacy</button>
        <button onclick="toggleLiveInput()">Start Color System</button>

        </br></br>
        <button id="exit-button" aria-label="Exit">Exit</button>

        <div id="noise-details">
            <p>dB: <span id="db">0</span></p>
            <p>Frequency: <span id="freq">•</span></p>
            <p>Note: <span id="note">•</span></p>
            <p>Cents ♭: <span id="cents">•</span></p>
            <!-- <div id="detector" class="vague">
                Frequency: <div class="pitch"><span id="pitch"></span></div>
                </br></br>
                Note: <div class="note"><span id="note"></span></div>
                <canvas id="output" width=300 height=42></canvas>
                <div id="detune"><span id="detune_amt"></span>
                    <span id="flat">cents &#9837;</span>
                    </br></br>
                    <span id="sharp">cents &#9839;</span>
                </div>
            </div> -->

            </br>
            <p>Waveform:</p>
            <canvas id="waveform" width="512" height="256" transform="scale(0.5)"></canvas>
            </br></br>
            <button id="tone-generator" aria-label="Play Tone Generator" href="">Play Tone Generator</button>
            </br></br></br></br>
            <!-- <input type="range" id="tone-slider" min="40" max="1500" step="1" value="230"/> -->
            <div id="tone-slider">
                <div id="custom-handle" class="ui-slider-handle"></div>
            </div>
        </div>

    </div>
</div>

</body>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://code.jquery.com/ui/jquery-ui-git.js"></script>
<script src="js/pitchdetect.js"></script>
<script src="js/tone-generator.js"></script>
<script>
    window.onload = function() {
        initPitchDetect(updateValues);
        initConfig();
        loadPatterns();
        applyConfig();
        bindPatternButtonClicks();
        bindSlider();
        bindExitButtonClick();
        bindSpaceKey();
    }

    function initConfig() {
        window.Config = {};
        window.Config.selectedPattern = getURLParam('pattern') || "chromesthesia";
        $("#" + window.Config.selectedPattern + "-button").prop("disabled", true);
        window.Config.hideDetails = getURLParam('details') == "false";
    }

    function loadPatterns() {
        $.getJSON("js/patterns.json", function(data) {
            window.ColorPatterns = data;
            window.Config.currentPattern = window.ColorPatterns[window.Config.selectedPattern]
            window.applyConfig();
        });
    }

    function applyConfig() {
        updateDetailsView();
    }

    function updateDetailsView() {
        window.Config.hideDetails ?
            $("#details-view").first().hide():
            $("#details-view").first().show();
    }

    function bindPatternButtonClicks() {
        $(".pattern-button").click(function(e) {
            window.Config.selectedPattern = e.target.textContent.toLowerCase();
            window.Config.currentPattern = window.ColorPatterns[window.Config.selectedPattern]
            applyConfig();
            e.preventDefault();
            $(".pattern-button").prop('disabled', false);
            e.target.disabled = true;
        });

        $("#tone-generator").click(function(e) {
            $("#tone-generator").text() == "Play Tone Generator" ? $("#tone-generator").text("Pause Tone Generator") : $("#tone-generator").text("Play Tone Generator");
            var value = $("#tone-slider").slider("option",'value');
            window.ToneGenerator.togglePlay(value);
        });
    }

    function bindExitButtonClick() {
        $("#exit-button").click(function(e) {
            window.location = "/home.html";
            window.Config.hideDetails = true;
            updateDetailsView();
        });
    }

    function bindSlider() {
        var handle = $( "#custom-handle" );
        $("#tone-slider").slider({
            min: 40,
            max: 648,
            value: 80,
            step: 1,
            create: function() {
                handle.text( $( this ).slider( "value" ) );
            },
            slide: function(event,ui) {
                handle.text( ui.value );
                if (window.ToneGenerator.isPlaying) {
                    window.ToneGenerator.updateTone(ui.value);
                }
            }
        });
    }

    function bindSpaceKey() {
        $('body').keyup(function(e) {
            if(window.Config.hideDetails) {
                window.location = "/home.html";
            }

            if(e.keyCode == 32) {
                $("#tone-generator").click();
            }
        });
    }

    function getURLParam(param) {
        return (new URLSearchParams(window.location.search)).get(param)
    }

    function updateValues() {
        $("#freq").html(window.PitchDetect.pitch || "•");
        $("#note").html(window.PitchDetect.noteLetter || "•");
        $("#cents").html(window.PitchDetect.detune || "•");
        // $("#db").html(window.PitchDetect.pitch || "•");

        var color = window.Config.currentPattern[window.PitchDetect.noteLetter];
        document.body.style.backgroundColor = color;

    }
</script>
</html>
